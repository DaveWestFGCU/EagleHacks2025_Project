<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Data Viewer</title>
    <link rel="stylesheet" href="static/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
    {% include 'navbar.html' %}

    <div class="content">
        <h1>Marketing Data Viewer</h1>
        <p>Data visualization will be available here soon.</p>
    </div>

    <div style="width: 800px"><canvas id="graph1"></canvas></div>>
    <div style="width: 800px"><canvas id="graph2"></canvas></div>>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function processChartData(data) {
                console.log("Parsed Data:", data); // Debugging
                
                let dates = [];          // Separate the dates  
                let products = [];       // Separate the ad pitches
                let impressions = [];    
                let clicks = [];
                let conversions = [];
                let ctrs = []
                let costs = [];
                
                data.forEach(row =>{
                    let product = row["Product/Service"];
                    let impression = parseFloat(row["Impressions"]);

                    if (!products.includes(product)) {
                        products.push(product);
                        impressions.push(impression);
                    } else {
                        let index = products.indexOf(product);
                        impressions[index] += impression; // Aggregate values for the same category
                    }

                })

                impressionsByAds(products, impressions);
                
                let categories = [];    // Should use "Channel"
                let counts = [];         // Should use a valid numerical column (e.g., "Impressions")                
                  
                data.forEach(row => {
                    let category = row["Channel"] || "Unknown";  // Use "Channel" instead of "Category"
                    let value = parseFloat(row["Impressions"]);  // Use a valid numeric field

                    if (!categories.includes(category)) {
                        categories.push(category);
                        counts.push(value);
                    } else {
                        let index = categories.indexOf(category);
                        counts[index] += value; // Aggregate values for the same category
                    }
                });
                impressionsByWebsite(categories, counts);       

            }


            function impressionsByAds(labels, values){
                let ctx = document.getElementById("graph1").getContext("2d");
                if (!ctx) {
                    console.error("Canvas element not found!");
                    return;
                }
                new Chart(ctx, {
                    type:"bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Impressions By Ads",
                            data: values,
                            backgroundColor: "rgba(75, 192, 192, 0.5)"
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }


            function impressionsByWebsite(labels, values) {
                let ctx = document.getElementById("graph2").getContext("2d");
                if (!ctx) {
                    console.error("Canvas element not found!");
                    return;
                }
                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Impressions by Website",
                            data: values,
                            backgroundColor: "rgba(75, 192, 192, 0.5)"
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }

            fetch("/marketing_data.csv")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("CSV file not found");
                    }
                    return response.text();
                })
                .then(csvText => {
                    console.log("CSV Loaded:", csvText);  // Debugging
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function (result) {
                            processChartData(result.data);  // âœ… Now this function is defined
                        }
                    });
                })
                .catch(error => console.error("Error loading CSV:", error));
        });
    </script>
</body>
</html>
